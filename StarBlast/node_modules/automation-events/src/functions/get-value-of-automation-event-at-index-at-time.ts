import { getTargetValueAtTime } from 'automation-events/src/functions/get-target-value-at-time';
import { isAnyRampToValueAutomationEvent } from 'automation-events/src/guards/any-ramp-to-value-automation-event';
import { isSetValueAutomationEvent } from 'automation-events/src/guards/set-value-automation-event';
import { isSetValueCurveAutomationEvent } from 'automation-events/src/guards/set-value-curve-automation-event';
import { TPersistentAutomationEvent } from 'automation-events/src/types';

export const getValueOfAutomationEventAtIndexAtTime = (
    automationEvents: TPersistentAutomationEvent[],
    index: number,
    time: number,
    defaultValue: number
): number => {
    const automationEvent = automationEvents[index];

    return automationEvent === undefined
        ? defaultValue
        : isAnyRampToValueAutomationEvent(automationEvent) || isSetValueAutomationEvent(automationEvent)
        ? automationEvent.value
        : isSetValueCurveAutomationEvent(automationEvent)
        ? automationEvent.values[automationEvent.values.length - 1]
        : getTargetValueAtTime(
              time,
              getValueOfAutomationEventAtIndexAtTime(automationEvents, index - 1, automationEvent.startTime, defaultValue),
              automationEvent
          );
};
